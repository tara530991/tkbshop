<!DOCTYPE html>
<html>
<head></head>
    <title>購物車</title>
    <style>
        #total,#total+span{font-size:2rem;}
    </style>
</head>
<% include header %>
<body>
    <div id="wrapper">
        <div id="page">
            <div class="row">
                <div class="col-lg-12">
                    <h1 class="page-header">購物車清單</h1>
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <!-- /.row -->
            <div class="row wrap1280">
                <div class="col-lg-12">
                    <% if (data.length == 0) {%>
                        <div>還沒有選購任何產品喔</div>
                    <% } else { %>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                             DataTables Advanced Tables
                        </div>
                        <!-- /.panel-heading -->
                        <form id="mainForm" action="/deleteproduct" method="">
                            <input type="hidden" id="productId" name="productId" />
                            <div id="panBody" class="panel-body">
                                <div id="cart_list">
                                    <table width="100%" class="table table-striped table-bordered table-hover" id="dataTables-example">
                                        <thead>
                                            <tr>
                                                <th>品名</th>
                                                <th>售價</th>
                                                <th>購買數量</th>
                                                <th>更改購買數量</th>
                                                <th>合計金額</th>
                                                <th>刪除產品</th>
                                            </tr>
                                        </thead>
                                            <tbody>
                                            <% for(var i=0 ; i < data.length;i++) { %>
                                                <tr class="odd gradeX"> 
                                                    <td>
                                                        <%=data[i].product_name %>
                                                    </td>
                                                    <td>
                                                        <%=data[i].price %>
                                                    </td>
                                                    <td class="amount">
                                                        <%=data[i].PRODUCT_AMOUNT %>
                                                    </td>
                                                    <td>
                                                        <input type="button" value="+" onclick="add(this,<%=data[i].PD_ID %>)" />
                                                        <input type="button" value="-" onclick="cut(this,<%=data[i].PD_ID %>)" />
                                                    </td>
                                                    <td class="subtotal"><%=data[i].subtotal %></td>
                                                    <td>
                                                        <input type="button" id="delete" onclick="deleteAction(<%=data[i].PD_ID %>)" value="刪除">
                                                    </td>
                                                </tr>
                                            <% } %>
                                        </tbody>
                                    </table>
                                    <div><span id="total">總價：</span><span>元</span></div>
                                    <button type="button" id="check" onclick="checkAction()">進入結帳</button>
                                </div>
                                </form>
                                <!-- /.table-responsive -->
                            </div>
                        <!-- /.panel-body -->
                    </div>
                    <!-- /.panel -->
                    <% } %>
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <!-- /.row -->
    <script>
        $(function () {
            var totalAdd = 0;
            var request = new XMLHttpRequest();
            //取值方法2
            // console.log(mathScore);
            // for(var i=0;i<mathScore.length;i++){
            //     console.log(mathScore[i]);
            // }
            $(".subtotal").each(function(i){
                totalAdd += parseInt($(this).text());
                // var total = [];
                return totalAdd;     
            });
            $("#total").append("<span>" + totalAdd + "</span>");
            // console.log($("#productId").val());
        });

        function add(k, id) {　//k是指input本身，id則是PD_ID
            $('#productId').val(id);　　//把PD_ID放到productId裡面
            console.log($('#productId').val());
            $(id).parent().parent().find('.amount').text().replace(' ', '');  //把產品的id取出
            var amount = parseInt($(k).parent().parent().find('.amount').text()) + 1;  //改變amount的值
            console.log(amount);
            // console.log($('#productId').text());        
            $(k).parent().parent().find('.amount').text(amount);　//把改好的值放回amount中（前端表格）
            updateAmount(amount);  //把改變的值傳到令一個函數做ajax的即時更動
        }

        function cut(k, id) {
            $('#productId').val(id);
            console.log($('#productId').val());
            // console.log($(i).parent().parent().find('.amount').text());
            $(id).parent().parent().find('.amount').text().replace(' ', '');
            // console.log($(i).parent().parent().find('.amount').text().replace(' ', ''));
            var amount = parseInt($(k).parent().parent().find('.amount').text()) - 1;
            if (amount < 1) {
                amount = 1;
            }
            console.log(amount);
            $(k).parent().parent().find('.amount').text(amount);
            updateAmount(amount);
        }

        function updateAmount(amount) {
            var totalAdd = 0;
            $.ajax({
                url: '/product/ajaxUpdateCart',
                method: 'GET',
                dataType: 'text',
                data: {
                    productId: $('#productId').val(),
                    amount: amount,
                },
                success: function (data) {
                    $('#cart_list').remove();
                    $('#panBody').append(data);
                    $(".subtotal").each(function (i) {
                        totalAdd += parseInt($(this).text());
                        return totalAdd;
                    });
                    $("#total").append("<span>" + totalAdd + "</span>");
                },
                err: function () {
                    console.log(err);
                }
            })
        }

        function deleteAction(i) {
            var totalAdd = 0;
            $('#productId').val(i);            
            $.ajax({
                url:'/product/ajaxDeleteCart',
                method:'POST',
                type:'text',
                data:{
                    productId: $('#productId').val(),
                },
                success: function(data){
                    $('#cart_list').remove();
                    $('#panBody').append(data);$('#productId').val(i);

                    $(".subtotal").each(function (i) {
                        totalAdd += parseInt($(this).text());
                        return totalAdd;
                    });
                    $("#total").append("<span>" + totalAdd + "</span>");                    
                },
                err: function () {
                    console.log(err);
                }
            })
        }
        function checkAction() {
            //改變form的action與method，這樣一個檔案中就不會有多個form了
            $("#mainForm").attr("action","/check");
            $("#mainForm").attr("method","post");
        }
    </script>
</body>
</html>