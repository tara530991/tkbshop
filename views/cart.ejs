<!DOCTYPE html>
<html>
<head></head>
    <title>購物車</title>
    <style>
        #total,#total+span{font-size:2rem;}
    </style>
</head>
<% include header %>
<body>
    <div id="wrapper">
        <div id="page">
            <div class="row">
                <div class="col-lg-12">
                    <h1 class="page-header">購物車清單</h1>
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <!-- /.row -->
            <div class="row wrap1280">
                <div class="col-lg-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                             DataTables Advanced Tables
                        </div>
                        <!-- /.panel-heading -->
                            <input type="hidden" id="productId" name="productId" />
                            <div id="panBody" class="panel-body">
                                <table id="cart_list" width="100%" class="table table-striped table-bordered table-hover" id="dataTables-example">
                                    <form id="mainForm" action="/deleteproduct" method="GET">
                                    <thead>
                                        <tr>
                                            <th>編號</th>
                                            <th>品名</th>
                                            <th>售價</th>
                                            <th>購買數量</th>
                                            <th>更改購買數量</th>
                                            <th>合計金額</th>
                                            <th>刪除產品</th>
                                        </tr>
                                    </thead>
                                    <% if (loginStatus == false) { %>
                                        <tbody>
                                        <% for(var i=0 ; i < data.length;i++) { %>
                                            
                                            <tr class="odd gradeX">
                                                <td class="pd_id">
                                                    <%=data[i].id%>
                                                </td>
                                                <td>
                                                    <%=data[i].product_name %>
                                                </td>
                                                <td>
                                                    <%=data[i].price %>
                                                </td>
                                                <td class="amount">
                                                    <%=data[i].amount %>
                                                </td>
                                                <td id="amountBtn">
                                                    <input type="button" class="add" value="+" onclick="add(this)" />
                                                    <input type="button" class="add" value="-" onclick="cut(this)">
                                                </td>
                                                <td class="subtotal"><%=data[i].subtotal %></td>
                                                <td>
                                                    <input type="button" id="delete" onclick="deleteAction()" value="刪除">
                                                </td>
                                            </tr>
                                        <% } %>
                                    <% } %>
                                    </tbody>
                                </table>
                                   <div><span id="total">總價：</span><span>元</span></div>
                                    <button type="submit" id="check" onclick="checkAction()">進入結帳</button>
                                </form>
                                <!-- /.table-responsive -->
                            </div>
                        <!-- /.panel-body -->
                    </div>
                    <!-- /.panel -->
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <!-- /.row -->
    <script>
        $(function () {
            var totalAdd = 0;
            var request = new XMLHttpRequest();
            //取值方法2
            // console.log(mathScore);
            // for(var i=0;i<mathScore.length;i++){
            //     console.log(mathScore[i]);
            // }
            $(".subtotal").each(function(i){
                totalAdd += parseInt($(this).text());
                // var total = [];
                return totalAdd;     
            });
            $("#total").append("<span>" + totalAdd + "</span>");
            console.log($("#productId").text());
         
            // $('#amountBtn').on('click',function(){
            //     var stringAmount = $('.amount').text().replace(/ /g, ',');
            //     var changeAmount = 0;
            //     for(var i = 0;i < stringAmount.length;i++){
            //         changeAmount[i] = parseInt(stringAmount[i]);
            //     }
            //     console.log("change:" + changeAmount);
            //     alert("change:" + changeAmount);
            //     $.ajax({
            //         url:'product/ajax_cart',
            //         method:'GET',
            //         dataType:'text',
            //         data:{
            //             amount:$('.amount').text().replace(/ /g,''),
            //         },
            //         success:function(){
            //             $('#cart_list').remove(data);
            //             $('#panBody').append(data);
            //         },
            //         err:function(){
            //             console.log(err);
            //         }
            //     })
            //     request.open('GET','/product/ajaxCart');
            //     request.send();
            // })            

        });

        function updateAmount(id,amount) {

            $.ajax({
                url: 'product/ajax_cart',
                method: 'GET',
                dataType: 'text',
                data: {
                    id:id,
                    amount: amount
                },
                success: function () {
                    $('#cart_list').remove(data);
                    $('#panBody').append(data);
                },
                err: function () {
                    console.log(err);
                }
            })
            request.open('GET', '/product/ajaxCart');
            request.send();
        }

        function add(id,i) {
            // console.log(amount);
            // console.log($(i).parent().parent());
            console.log($(i).parent().parent().find('.amount').text());
            $(i).parent().parent().find('.amount').text().replace(' ','');
            console.log($(i).parent().parent().find('.amount').text().replace(' ', ''));
            amount = parseInt($(i).parent().parent().find('.amount').text())+1;
            console.log(amount);
            updateAmount(id, amount);
            $(i).parent().parent().find('.amount').text(amount);
            
        }

        function cut(id,i) {
            console.log($(i).parent().parent().find('.amount').text());
            $(i).parent().parent().find('.amount').text().replace(' ', '');
            console.log($(i).parent().parent().find('.amount').text().replace(' ', ''));
            amount = parseInt($(i).parent().parent().find('.amount').text()) - 1;
            console.log(amount);
            updateAmount(id, amount);
            $(i).parent().parent().find('.amount').text(amount);
        }

        //改變form的action與method，這樣一個檔案終究不會有多個form了
        function deleteAction() {
            $("#mainForm").attr("action","deleteproduct");
        }
        function checkAction() {
            $("#mainForm").attr("action","check");
            $("#mainForm").attr("method","post");
        }
    </script>
</body>
</html>